const crypto = require('crypto');

module.exports = (req, res, next) => {
  const signature = req.headers['x-mercadopago-signature'];

  if (!signature) {
    console.log('Assinatura não encontrada');
    return res.status(401).send('Unauthorized');
  }

  const payload = JSON.stringify(req.body);
  const hash = crypto
    .createHmac('sha256', process.env.MERCADOPAGO_WEBHOOK_SECRET)
    .update(payload)
    .digest('hex');

  if (hash !== signature) {
    console.log('Assinatura inválida');
    return res.status(401).send('Unauthorized');
  }

  next();
};
